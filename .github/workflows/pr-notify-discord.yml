name: Notify Discord on PR

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Extract problem info
        id: extract
        run: |
          # PRボディから問題情報を抽出
          PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)
          
          # 2行目から問題情報を取得（## 解く問題の次の行）
          PROBLEM_LINE=$(echo "$PR_BODY" | sed -n '2p')
          
          # [問題名](URL) の形式から抽出
          PROBLEM_NAME=$(echo "$PROBLEM_LINE" | sed -n 's/^\[\([^]]*\)\].*/\1/p')
          PROBLEM_URL=$(echo "$PROBLEM_LINE" | sed -n 's/^[^(]*(\([^)]*\)).*/\1/p')
          
          echo "problem_name=${PROBLEM_NAME}" >> $GITHUB_OUTPUT
          echo "problem_url=${PROBLEM_URL}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Discord message and post as PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PROBLEM_NAME="${{ steps.extract.outputs.problem_name }}"
          PROBLEM_URL="${{ steps.extract.outputs.problem_url }}"
          
          # Discordメッセージを作成
          cat << EOF > message.txt
          お疲れ様です。
          
          ${PROBLEM_NAME}に取り組みました。  
          お手隙の際にレビューをお願いいたします。
          
          問題: ${PROBLEM_URL} 
          PR: ${PR_URL} 
          言語: Python3
          EOF
          
          # PRにコメントとして投稿
          gh pr comment "$PR_NUMBER" --body-file message.txt
